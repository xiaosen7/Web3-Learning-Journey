# 北京大学肖臻老师《区块链技术与应用》公开课_导读
2024年10月29日 11:12

## 关键词
比特币 交易 脚本语言 输入 输出 确认 vin 哈希值 版本 size 输入脚本 输出脚本 script sig public key hash check sig input script output script equal verify stack 序列化 


## 全文摘要
比特币交易通过一种基于栈的脚本语言实现，这门语言不支持循环或变量等复杂编程概念，专为执行特定的密码学操作而设计，如签名验证。支付给公钥、公钥哈希以及脚本哈希三种格式覆盖了比特币交易的主要场景，其中脚本哈希形式支持复杂逻辑，如多重签名交易。脚本通过输入与输出脚本配对执行来验证交易，确保其合法性。多重签名和特定目的的比特币销毁操作也通过脚本实现。尽管该脚本语言针对比特币需求进行了优化，提供简洁高效的交易验证方式，但它与更复杂的编程语言相比，功能相对有限。


## 章节速览
##### 00:00 理解比特币交易中的脚本语言
讨论了比特币交易中使用的脚本语言和一个具体交易实例，包括输入输出结构、脚本执行流程及含义。交易包含一个输入和两个输出，使用栈为基础的语言处理交易信息，脚本涉及公共密钥和哈希值，以及确认信息和锁定时间的概念。

##### 06:42 区块链交易验证流程
讨论了区块链中交易验证的过程，包括交易输入和输出脚本的交互验证，以及安全措施的变更。首先，一个交易的合法性需要通过输入脚本与对应输出脚本的匹配验证来确认，最初这两个脚本是连续执行，但为了安全，改为分别执行。如果所有输入脚本与输出脚本验证均通过，交易则被认为是合法的。接着，介绍了两种基本的交易脚本形式：支付给公钥（pay to public key）和其验证过程。最后，演示了脚本是如何在验证交易时被使用的，包括签名的检查和公钥的验证。

##### 10:49 理解比特币脚本中的Pay to Public Key Hash
讨论了比特币交易中的一种常见脚本形式——Pay to Public Key Hash（P2PKH）。这种形式中，输出脚本不直接列出收款人公钥，而是使用公钥的哈希值。公钥与签名信息一同在输入脚本中提供。脚本执行过程涉及复制栈顶元素、取哈希值和验证签名，确保交易的合法性和防止冒充行为。P2PKH因其简单性和广泛适用性而成为比特币交易中最常用的脚本形式。

##### 14:52 理解Pay to Script Hash交易脚本
Pay to Script Hash（P2SH）是一种复杂的比特币交易脚本形式，它允许用户通过提供一个脚本的哈希值来指定资金的接收条件，而这个脚本（赎回脚本）在将来花这笔钱时才被展示。验证过程包括两步：首先验证输入脚本给出的赎回脚本哈希与输出脚本一致，其次执行赎回脚本确保其逻辑正确。本文通过实例说明如何使用P2SH实现类似于Pay to Public Key Hash的功能，展示了签名和序列化赎回脚本在交易验证过程中的作用。

##### 17:07 理解Pay to Script Hash的执行过程及其多重签名功能
讨论了Pay to Script Hash (P2SH) 的执行流程，强调了输入脚本和输出脚本的拼接、信号压栈、赎回脚本处理、哈希值比较等关键步骤。解释了P2SH如何支持多重签名交易，通过设定N个公钥和M个签名验证要求，以应对私钥泄露或丢失的风险。同时，讨论了实现中的一个bug及其解决方案，展示了为适应bug而在脚本中添加额外元素的策略。

##### 23:59 Pay to Script Hash in Bitcoin for Multi-Signature Transactions
This discussion focuses on the use of pay to script hash for implementing multi-signature transactions in Bitcoin, offering a solution to the complexity of traditional multi-sig methods. By moving the complexity to the input script, it simplifies the output script for users, allowing them to pay without needing to know the underlying rules set by the recipient. This approach is illustrated with an example of an e-commerce scenario where multiple parties must sign a transaction, highlighting the convenience and flexibility it offers compared to conventional methods.

##### 31:20 理解比特币脚本中的特殊输出格式及其用途
讨论了一种特殊的比特币脚本格式，其以'return'操作开头，用于无条件返回错误，从而提前终止脚本执行。这种格式在比特币中用于证明销毁比特币以获取其他币种或在区块链中永久保存信息，如知识产权的证明。此外，还介绍了这种方法的应用场景，如小币种的获取和区块链内容的不可篡改性存储，并对比特币脚本语言的特点进行了简要说明，强调了其简洁性和针对比特币应用场景的优化。


## 思维导图
![思维导图图片](https://tw-efficiency.biz.aliyun.com/api/export/get/v2/mloynm2ol24qagpb-1730172694000-f73c7fb41e914b5a9c817771fd6c3124.jpg)
## 要点回顾
##### 比特币交易中的脚本语言是如何运作的？
比特币交易使用基于栈的语言（stack based language），其中输入脚本包含操作将输入的比特币压入栈中，而输出脚本则为每个输出单独编写，用于设定支付条件。例如，在交易实例中，输入脚本执行了两次“压入栈”的操作，输出脚本则根据交易的接收者设定不同的验证规则。

##### 交易中的vin、vout以及它们所代表的信息是什么？
vin表示交易的输入部分，每个输入都需要指定该输入花费的币来自之前哪个交易的哪个输出，包含输出交易的ID和输出序号。vout则是交易的输出部分，表示当前输出的金额和对应的序号，输出可以设定为只需要一个签名即可兑现，也可以设定为多重签名等不同类型。

##### 比特币交易中提到的lock time是什么意思，它如何影响交易的生效时间？
lock time是一个用来设定交易生效时间的参数，在比特币协议中，默认为零，表示交易立即生效。非零的lock time意味着交易需要等待特定数量的区块确认后才能被写入区块链，这是特殊情况下用来控制交易确认顺序和安全性的一个机制。

##### 比特币交易的输入脚本和输出脚本是如何执行验证的？
为了验证交易合法性，需要将交易的输入脚本与对应的输出脚本按照特定顺序拼接起来执行。早期实践中是将两者拼接执行一遍，现在出于安全考虑改为分别执行。如果所有输入脚本对应的输出脚本都能顺利执行且栈顶结果为非零值，则验证通过，反之则交易被视为非法。

##### 支付到公钥和检查签名这两种脚本形式是什么样的？
一种最简单的脚本形式是pay to public key，输出脚本直接包含收款人的公钥，而输入脚本则包含对交易签名的检查操作check sig，这个签名是由私钥对应输入脚本生成的。通过这种方式，确保只有拥有对应私钥的用户能够花费该输出。

##### Pay to Public Key Hash脚本形式有何特点？
Pay to Public Key Hash脚本形式与前者不同，它在输出脚本中并未直接给出收款人的公钥，而是提供了公钥的哈希值。输入脚本需要提供签名和公钥，输出脚本则通过一系列操作（如dup、160、hash 160等）验证签名正确性，防止冒名顶替。这种形式是最常用的脚本形式之一。

##### 如何执行Pay to Public Key Hash脚本并确保其合法？
执行过程中，首先将输入脚本中的签名和输出脚本中的公钥哈希值压入栈，接着通过一系列栈操作比较和验证两者是否匹配，最后用check sig检查签名是否与公钥对应正确。如果所有步骤都顺利通过，则交易合法；否则，交易被认为是非法的。

##### Pay to Public Key脚本形式是如何工作的？
在Pay to Public Key脚本中，输入脚本首先将签名压入栈，然后输出脚本包含两行：第一行将收款人的公钥压入栈，第二行执行check sig操作以验证签名的正确性。这种形式相对直接，但不如Pay to Public Key Hash常见。

##### Pay to Script Hash脚本形式是什么，以及其验证过程是怎样的？
Pay to Script Hash脚本形式下，输出脚本包含的是赎回脚本的哈希值。当交易被验证时，首先进行两阶段验证：第一阶段验证输入脚本中的赎回脚本哈希值是否与输出脚本中的匹配；第二阶段解序列化输入脚本中的赎回脚本并执行，通过check sig再次验证签名的有效性。只有这两步都成功通过，该交易才被认为是合法的。

##### 为何要使用Pay to Script Hash而非Pay to Public Key？
尽管对于简单案例来说，Pay to Script Hash可能显得复杂，但在比特币的早期版本中并未支持对多重签名的支持。通过引入Pay to Script Hash功能，可以实现更复杂的安全机制，例如多重签名，这在软分叉升级后得以实现。

##### 在比特币系统中，如何通过check multi sig实现多重签名以保护资金安全？
在比特币系统中，一个输出可能要求多个签名才能取出资金，例如需要五个合伙人中任意三个人的签名才能动用公司账户上的钱。这种机制为私钥泄露提供了安全保障，即使有单个合伙人私钥泄露，仍需其他M个签名才能取出资金。同时，即使有M-1个合伙人忘记私钥，剩下的N-M个合伙人仍能通过签名验证取出资金。具体实现是通过check multi sig操作，在输出脚本中指定N个公钥和一个阈值M，只要提供任意M个合法签名就能通过验证。

##### check multi sig是否存在bug，如何解决这个问题？
check multi sig在执行过程中存在一个已知bug，即会从堆栈上多弹出一个元素。由于比特币系统的去中心化特性，无法通过软件升级修复这个bug，实际解决方案是在输入脚本中额外添加一个无用元素来迁就这个bug。此外，需要注意输入脚本中签名的相对顺序必须与公钥中的顺序一致。

##### 早期使用check multi sig实现多重签名存在哪些不方便之处？如何利用pay to script hash改进多重签名方案并解决上述问题？
早期使用check multi sig实现的多重签名在实际应用中有不方便之处，如电商要求用户在支付时提供多个合伙人的公钥、N和M的值等复杂信息，这给用户在网上购物生成转账交易带来了困扰，因为不同的电商可能采用不同的多重签名规则，增加了用户的操作难度和信息负担。通过使用pay to script hash，复杂度从输出脚本转移到了输入脚本，使得输出脚本变得简单，只需要给出赎回脚本的哈希值即可。赎回脚本内包含N个公钥和N、M的值，由收款人（如电商）提供并公布。这样，用户只需在转账交易中包含这个哈希值，而无需关心电商具体采用的多重签名规则，极大简化了用户的操作流程。输入脚本在花销时会包含赎回脚本的序列化版本和验证所需M个签名，若电商更改了多重签名规则，只需更新输入脚本和公布新的哈希值，对用户而言只需支付时包含变化后的哈希值即可。

##### 为什么会出现这种特殊的输出脚本格式，它为何会导致脚本无法通过验证执行？这种特殊的输出脚本格式在什么场景下被应用？
这种特殊的输出脚本格式是设计用来证明销毁比特币的一种方法。其中，return操作的无条件返回错误特性意味着一旦执行到这个return语句，脚本就会立即报错并终止执行，后面的内容将无法被执行。这种设计虽然看似限制了脚本的正常运行，但它的目的是为了实现特定功能，如证明销毁比特币或在区块链中永久保存某些内容。该格式主要应用于两个场景。一种情况是小币种（auto coin）要求销毁一定数量的比特币以获得该小币种，例如需要销毁1个比特币来得到1000个该小币种。另一种情况是在区块链中写入不可篡改的内容，如知识产权保护，通过将知识产权内容取哈希后放入return语句后的部分，这样既节省空间又保护隐私，在发生纠纷时可以公布原始内容。

##### 使用这种脚本格式是否需要拥有记账权？
不同于Coin base交易中的coin base域，这种特殊的输出脚本格式任何节点甚至普通用户都可以使用，只需支付少量比特币（如0.001个比特币）即可有机会在区块链中写入内容。而发布交易时，是否需要记账权取决于交易的具体类型，发布区块才需要记账权。

##### 比特币系统中的脚本语言具有哪些特点？
比特币系统使用的脚本语言是非常简单且功能有限的，甚至没有专门的名字，被称为比特币脚本语言。它的设计有其独特之处，比如不支持循环以避免死循环问题，这与以太坊等区块链平台采用的智能合约语言形成对比，后者支持更复杂的图灵完备功能并需通过汽油费机制防范死循环。尽管比特币脚本语言在功能上看似有限，但它在与密码学相关的功能上表现强大，例如通过单条语句就能实现多重签名等复杂操作。


## 提取PPT
##### 00:00 理解比特币交易中的脚本语言
![PPT图片](https://tw-efficiency.biz.aliyun.com/api/lab/get/v2/47z39v2vdwmgnedg/23576887.png)

![PPT图片](https://tw-efficiency.biz.aliyun.com/api/lab/get/v2/47z39v2vdwmgnedg/23576888.png)
1. 本次讨论的交易特征为单一输入和双输出结构，其中被标记为"output"的部分实指输入，指明了该输入所消耗的币是从哪个输出中转移而来；2. 交易已获得23次确认，这意味着回滚的可能性极小，交易稳定且被网络广泛认可；3. 交易的输入脚本设计巧妙，通过将两个复杂元素压入栈中进行操作，体现了比特币交易脚本语言的独特性，即基于栈的操作，与常见的面向对象或过程化编程语言有显著差异；4. 输出脚本部分针对交易的两个输出分别设计了独立的脚本段落，确保每个输出的处理逻辑清晰、独立，符合比特币交易验证和解锁机制的要求；5. 比特币的脚本语言设计精简，仅支持堆栈操作，没有全局或局部变量的概念，也无动态内存分配，这种设计虽然限制了功能的复杂性，但也确保了交易的执行效率和安全性。

![PPT图片](https://tw-efficiency.biz.aliyun.com/api/lab/get/v2/47z39v2vdwmgnedg/23576889.png)
1. 该对话首先介绍了比特币交易的元数据（meta data），包括交易ID，交易的哈希值（hash），使用的比特币协议版本，交易大小（size），以及lock time（交易生效时间）。
2. 其中，lock time 设定为零表示交易立即生效，非零值则表示交易需等待一定区块确认后生效，这一功能用于某些特殊交易。
3. 对话还提到了交易的输入（vin）和输出（vout）部分，这是交易的核心，用于描述交易的财务流动，但具体细节未在当前PPT中展开。
4. 交易和所在区块的哈希值被提及，强调了哈希值通常以零开头的特点，反映了挖矿难度的要求。
5. 最后，对话简要说明了交易和区块产生的确认信息数量及时间，其中交易已经确认了23次，显示了时间与区块产生时间的对比，从初始时间点到当前时间点经过的秒数。

![PPT图片](https://tw-efficiency.biz.aliyun.com/api/lab/get/v2/47z39v2vdwmgnedg/23576890.png)
1. 交易输入结构是一个数组，一个交易可以包含多个输入，其中每个输入都需说明其花费的币来自之前交易的哪个输出。
2. 输入结构的前两行提供了输出币的来源信息，包括交易的哈希值和输出序号，例如，某输入表示其花费的币来源于哈希值为"C0CB"的交易的零号输出。
3. 输入脚本的示例为"scp sig"，表示输入脚本可能是一个简单的信号，用以证明持有者有权花费该笔资金，后续对话中将其简化标记为"input script"。
4. 当交易包含多个输入时，每个输入都需要明确其资金来源，并且每个输入可能需要不同的签名，以满足比特币交易的多重签名要求。
5. 比特币交易的签名机制确保了只有合法的所有者才能发起交易，通过在交易中包含相应的签名来验证每个输入的有效性。

![PPT图片](https://tw-efficiency.biz.aliyun.com/api/lab/get/v2/47z39v2vdwmgnedg/23576891.png)
1. 交易输出描述了一个数组结构，其中包含两个主要的输出，每个输出都有一个value，表示交易转出的金额，单位为比特币或satoshi，最小单位为satoshi，1比特币等于100000000个satoshi。
2. 每个输出都有一个特定的N序号，用以标识该交易中的输出位置，以及一个输出脚本（output script），该脚本通过ASM（Assembly语言）表示，定义了如何验证输出的合法性。
3. 输出脚本的请求（request）字段说明了兑现输出所需的签名数量，本例中每个输出仅需一个签名，涉及公共密钥的哈希操作，将来讨论的多重签名（multisignature）可能需要多个签名。
4. 输出类型和公钥哈希（public key hash）用于确定输出的验证方式，本例中类型为公共密钥哈希，表示输出通过公钥哈希进行验证。
5. 输出地址（address）提供了接收比特币的账户标识，但在此对话中并未详细解释其具体作用和实现方式。

![PPT图片](https://tw-efficiency.biz.aliyun.com/api/lab/get/v2/47z39v2vdwmgnedg/23576892.png)
1. 在区块链中，当一个用户（如B）进行转账给另一个用户（如C）的交易时，这个交易的合法性验证需要基于之前的交易记录（如A转给B的交易）的输出脚本和当前交易的输入脚本的交互执行。
2. 初始时，输入脚本与输出脚本被拼接在一起连续执行，但这可能引入安全风险。为了提升安全性，调整为分别执行输入脚本和输出脚本，确保交易的合法性。
3. 每个交易可能包含多个输入，每个输入的脚本需要与相应的输出脚本进行匹配验证，所有验证过程都通过才认定该交易合法。
4. 交易验证的核心在于检查输入脚本和输出脚本是否能够成功执行并最终产生非零值的栈顶结果，这标志着交易合法完成。
5. 通过理解交易输入输出脚本的交互执行机制和合法性验证流程，有助于深入掌握区块链技术中交易处理的基本原理和安全性考量。

##### 06:42 区块链交易验证流程
![PPT图片](https://tw-efficiency.biz.aliyun.com/api/lab/get/v2/47z39v2vdwmgnedg/23576893.png)
1. 在比特币交易中，一种基本形式是“pay to public key”，其中输出脚本直接包含了收款人的公钥，简化了交易验证流程。
2. 输入脚本中的“check sig”操作用于验证签名的正确性，这个签名是由私钥对整个交易进行签名得到的，确保了交易的合法性与所有权。
3. 实际操作中，虽然输入脚本和输出脚本需分别执行以保证安全，但为了演示和教学方便，通常在讲解中将它们合并显示，并按照顺序执行，从第一条语句开始。
4. 第一步是将输入脚本提供的签名压入栈顶，第二步则是将输出脚本中的公钥也压入栈顶，准备进行后续验证步骤。
5. 最终的“check sig”操作会弹出栈顶的签名和公钥，运用公钥来验证签名是否有效，以此决定整个交易是否合法通过。

![PPT图片](https://tw-efficiency.biz.aliyun.com/api/lab/get/v2/47z39v2vdwmgnedg/23576894.png)
1. 对话内容涉及两个比特币交易验证机制："pay to public key" 和 "pay to public key hash"，说明了它们的基本操作流程。
2. 在"pay to public key"机制中，输入脚本仅包含一个行，用于将签名压入栈，表明这是一个直接关联到公钥的支付方式。
3. 同一机制下，交易的来源（输出）包含两行：首先压入公钥，然后进行"check sig"操作，用于验证签名的有效性，这构成了支付的完整验证流程。
4. 对话接着引入了第二种形式，即"pay to public key hash"，暗示了对比特币地址验证方式的扩展，使得公钥经过散列后成为交易验证的对象，增加了交易的安全性和匿名性。
5. 综上所述，通过对比这两种机制，对话旨在阐述比特币交易验证机制的多样性和背后的逻辑，对理解比特币交易流程和安全性具有重要意义。

##### 10:49 理解比特币脚本中的Pay to Public Key Hash
![PPT图片](https://tw-efficiency.biz.aliyun.com/api/lab/get/v2/47z39v2vdwmgnedg/23576895.png)
1. 这种形式与之前讨论的不同的关键在于输出脚本不直接提供收款人的公钥，而是给出公钥的哈希值，而公钥本身是由输入脚本给出的，同时需要伴随签名信息，这样的设计增加了交易的安全性。
2. 在这种形式中，输出脚本的执行流程涉及到公钥哈希的复制、验证以及与输入脚本中给出的公钥哈希进行比较，这一过程确保了只有持有正确私钥的用户才能花费相应的比特币，防止了身份冒用。
3. 通过dup（复制栈顶元素）、hash 160（计算哈希值）等操作，脚本能够准确地将公钥和公钥哈希值正确对齐，为后续的签名验证奠定了基础。
4. equal verify（验证相等）操作是交易验证过程中的关键一步，它通过比较输入脚本与输出脚本中提供的哈希值是否一致，有效防止了假冒公钥带来的风险。
5. 整个脚本的执行逻辑围绕验证签名的正确性和公钥的匹配性展开，只有当所有步骤均成功完成，交易才被认为是合法的，否则将因错误而被判定为非法交易。

![PPT图片](https://tw-efficiency.biz.aliyun.com/api/lab/get/v2/47z39v2vdwmgnedg/23576896.png)
1. pay to public key hash 是最常用的脚本形式, 在我们演示的第一张幻灯片中可以找到例子, 这种脚本允许将签名压入栈, 并将公钥压入栈, 以便进行验证。
2. 输入脚本处理签名和公钥的压栈过程, 而输出脚本负责复制栈顶元素, 计算哈希值, 并通过比较和验证来确认签名的有效性。
3. 在这个过程中, 第三步是将公钥的哈希值压入栈, 通过这一操作增加了交易的安全性, 确保公钥与交易相关联的签名相匹配。

##### 14:52 理解Pay to Script Hash交易脚本
![PPT图片](https://tw-efficiency.biz.aliyun.com/api/lab/get/v2/47z39v2vdwmgnedg/23576897.png)
1. pay to script hash是一种复杂的脚本形式，不同于直接使用公钥哈希收款，而是需要用户提供一个脚本的哈希值作为收款依据。
2. 这种方式下，所谓的radium script即为赎回脚本，它定义了如何花费这笔资金的规则，需要在将来交易中被输入脚本引用。
3. 花费这笔资金时，除了赎回脚本的具体内容外，还必须提供相应的签名，以证明拥有执行该脚本所需权限。
4. 这种脚本形式的复杂性在于它允许更为灵活和定制化的交易条件，但同时也增加了交易的验证难度和操作复杂度。

![PPT图片](https://tw-efficiency.biz.aliyun.com/api/lab/get/v2/47z39v2vdwmgnedg/23576898.png)
1. 验证过程分为两步，首先检查输入脚本中的赎回脚本与输出脚本中的哈希值是否匹配，以确保赎回脚本的正确性。如果不匹配，则验证失败。
2. 如果第一步验证通过，接着执行赎回脚本的内容，以确认操作指令的正确执行，进一步确保交易的合法性。
3. Pay to script hash功能通过将赎回脚本的功能嵌入到交易中，实现了比传统的Pay to Public Key更高级的控制，如支持多重签名。
4. 该功能通过软分叉引入比特币系统，用于增强安全性，例如，当多个私钥中的一个泄露时，仍需其他私钥才能完成交易，提供了一定程度的私钥泄露保护。
5. 对于需要多个签名才能提取资金的场景，如公司账户管理，Pay to script hash支持任意多个签名者中的特定数量进行签名，确保即使部分私钥丢失或泄露，资金仍可安全转移至其他账户。

##### 17:07 理解Pay to Script Hash的执行过程及其多重签名功能
![PPT图片](https://tw-efficiency.biz.aliyun.com/api/lab/get/v2/47z39v2vdwmgnedg/23576899.png)
1. 对话内容涉及比特币中一个check multi-sig实现的bug，该bug导致执行时从堆栈上多弹出一个元素，这个问题由于系统的去中心化性质，目前无法通过软件升级进行修复，需要进行硬分叉。
2. 解决方案之一是在输入脚本中加入一个额外的、无用的元素，利用这个元素来弥补check multi-sig模式c在实现上的缺陷。
3. 该bug的存在，要求在提供给验证的签名中，输入脚本需要确保M个签名（其中M小于等于N，N为公钥总数）的相对顺序与N个公钥在脚本中的相对顺序一致，以确保验证的正确性。

![PPT图片](https://tw-efficiency.biz.aliyun.com/api/lab/get/v2/47z39v2vdwmgnedg/23576900.png)
1. 多重签名验证过程中，当提供两个签名时，其顺序与公钥列表中顺序一致，体现了签名与公钥相对应的原则。
2. 在执行check multi sig时，多余的元素被压入栈中，随后两个签名和相关公钥依次压入，展现了脚本执行的基本流程。
3. 早期通过比特币脚本中原生的check multi sig实现多重签名，但这种方式存在不便，特别是在用户生成转账交易时需要明确N和M的值。
4. 电商等场景中，多重签名的规则不一，要求不同数量的签名来验证交易，这增加了用户的操作复杂性和交易生成的难度。
5. 为解决上述问题，引入了pay to script hash（P2SH）机制，简化了多重签名交易的创建过程，使得用户无需直接处理签名和公钥数量的细节，从而提升了交易的便捷性和安全性。

##### 23:59 Pay to Script Hash in Bitcoin for Multi-Signature Transactions
![PPT图片](https://tw-efficiency.biz.aliyun.com/api/lab/get/v2/47z39v2vdwmgnedg/23576901.png)
1. 多重签名交易通过将复杂度从输出脚本转移到输入脚本，简化了输出脚本，使其仅需包含赎回脚本的哈希值，这使得交易过程对用户来说更加透明和易于操作。
2. 赎回脚本中包含N个公钥和M值，用于验证输入脚本中提供的M个签名，这实质上定义了所需的签名数量以花费该输出，而具体实现细节（如使用哪些公钥）由收款人决定。
3. 对用户而言，支付时只需关心并包含输出脚本中指定的赎回脚本哈希值，多重签名的具体规则（如M/N值）由收款方决定并公开，用户无需了解其内部细节，这与传统的公钥哈希支付方式在用户体验上没有本质区别。
4. 收款方（如电商）可以根据需要改变多重签名规则，只需相应更新输入脚本和赎回脚本内容，并公布新的哈希值，这种灵活性允许商家在不影响用户的情况下调整其安全策略。

![PPT图片](https://tw-efficiency.biz.aliyun.com/api/lab/get/v2/47z39v2vdwmgnedg/23576902.png)
1. 对话内容开始于描述输入脚本和输出脚本拼接的过程，特别提到了一个用于处理“check multi sig” bug的多余元素false，以及如何处理有效的签名和赎回脚本。
2. 在执行过程中，首先将false压入栈中作为起始操作，随后是两个签名的依次压入，随后是赎回脚本的序列化处理，暂时仅作为数据压入栈。
3. 输入脚本的执行在压入所有必要的数据后结束，接下来是输出脚本的哈希值计算，该哈希值被压入栈顶，作为后续验证的基础。
4. 验证过程分为两个阶段，第一阶段验证完成后，进入第二阶段，此阶段开始时，赎回脚本中的M被压入栈，标志着复杂逻辑的进一步执行。
5. 整个过程展示了复杂脚本执行的步骤，从数据压入、哈希计算到逻辑判断，每一步都紧密相连，确保了交易的有效性和安全性。

![PPT图片](https://tw-efficiency.biz.aliyun.com/api/lab/get/v2/47z39v2vdwmgnedg/23576903.png)

![PPT图片](https://tw-efficiency.biz.aliyun.com/api/lab/get/v2/47z39v2vdwmgnedg/23576904.png)
1. 对话内容涉及的是使用pay to script hash进行多重签名的过程，具体展示了如何通过脚本实现两个签名者中任意一个参与即可完成交易的机制，这体现了现代数字加密货币交易中对安全性和灵活性的平衡追求。
2. 提到的实例中，脚本的最后一个部分是序列化的赎回脚本，通过反序列化操作可明确获知这是一个基于三者之中任取两者的多重签名脚本，这种方法直观地展示了多重签名功能的实现方式。
3. 强调了当前多重签名交易普遍采用的pay to script hash格式，这种格式使得交易更加安全且不容易被破解，同时也便于区块链网络的验证与记录，是当前加密货币生态中主流的交易签名模式。
4. 特别指出了一种较为特殊的脚本格式，尽管未具体说明其内容，但可以推测这种格式可能在签名机制、验证过程或交易效率上有别于传统的pay to script hash，可能涉及更高级的安全策略或交易策略，值得进一步探讨和研究。

##### 31:20 理解比特币脚本中的特殊输出格式及其用途
![PPT图片](https://tw-efficiency.biz.aliyun.com/api/lab/get/v2/47z39v2vdwmgnedg/23576905.png)
1. 这种格式的输出脚本通过包含return语句无条件返回错误，导致执行脚本时立即终止，即使后面还有内容未执行。
2. 尽管看起来奇怪，设计这样的脚本是为了证明销毁比特币的一种方法，尤其在特殊场景下使用。
3. 破币销毁的目的包括满足小币种获取条件，或在区块链中永久保存重要信息，如digital commitment。
4. 使用return语句来存储哈希值，这种方法可确保区块链内容不可篡改，适用于知识产权保护等场景。
5. 与coin base transaction不同，这种销毁比特币的方法对全节点和普通用户都开放，允许在区块链中插入信息，尽管实际销毁的比特币量很少。

![PPT图片](https://tw-efficiency.biz.aliyun.com/api/lab/get/v2/47z39v2vdwmgnedg/23576906.png)
1. 对话内容涉及区块链技术中的交易机制，具体讨论了交易的两个输出及其脚本的特性。
2. 第一个输出的脚本是一个标准的支付给公钥哈希类型，其释放的金额等于区块奖励加上交易费用。
3. 第二个输出的金额被设定为零，但其输出脚本采用了特殊格式，以“return”开头，后跟有额外的复杂数据。
4. 这样的设计目的是在区块链上记录或嵌入某些特定的信息，可能用于记录交易的元数据或特殊用途。
5. 通过这种方式，区块链交易能够不仅进行价值转移，还能在交易记录中包含额外的数据，增强了区块链的信息承载能力。

![PPT图片](https://tw-efficiency.biz.aliyun.com/api/lab/get/v2/47z39v2vdwmgnedg/23576907.png)
1. 这个转账交易输出脚本是将全部0.05个比特币作为交易费用支付给矿工，不产生新的比特币输出。
2. 通过这种脚本，矿工能确认某些输出无法兑现，从而不必保存在未花费交易输出（UTXO）中，减少了对全节点的负担。
3. 在讨论中提到，虽然本PPT简化了比特币脚本语言的表示，未加入op前缀，但实际操作中应完整书写，以确保准确理解指令。
4. 比特币的脚本语言设计简单直接，虽不具备通用编程语言的所有功能，如循环，但通过这种方式避免了停机问题，且特别在密码学应用方面表现高效。
5. 与之相比，以太坊等区块链平台采用更为复杂的智能合约语言，支持图灵完备的计算能力，这要求通过“汽油费”机制来限制可能的无限循环问题。

![PPT图片](https://tw-efficiency.biz.aliyun.com/api/lab/get/v2/47z39v2vdwmgnedg/23576908.png)




