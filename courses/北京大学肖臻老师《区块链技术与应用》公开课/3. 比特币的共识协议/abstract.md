北京大学肖臻老师《区块链技术与应用》公开课\_原文

## 数字货币中心化方案

由央行发行数字货币,每个数字货币都带有央行的私钥签名。用户可以通过央行的公钥验证货币的真实性。这个方案存在双花攻击问题 - 数字货币本质是文件,可以被无限复制使用

为了解决双花问题,提出了改进的中心化方案:

1. 每个数字货币都有唯一编号
2. 央行维护一个数据库记录每个货币的所有者
3. 每次交易都需要央行验证货币归属并更新数据库

这个改进方案可以有效防范双花,但仍然存在明显缺陷:

1. 所有交易都需要经过央行确认,效率低下
2. 完全依赖中心化机构,缺乏去中心化的优势

这些问题促使了比特币这样的去中心化数字货币系统的诞生。

## 数字货币去中心化方案

### 去中心化货币的挑战

去中心化货币需要解决两个主要问题：一是数字货币的发行权归谁所有，二是如何验证交易的有效性并防止双花攻击。在比特币系统中，货币的发行权是通过挖矿来决定的。

### 区块链防范双花攻击

10:20

为了防范双花攻击，比特币系统采用了一个类似中心化方案的解决方案 - 区块链。区块链是一个由所有用户共同维护的数据结构，用于记录和验证每个比特币的交易历史，确保比特币不会被重复使用。

区块链通过记录交易历史来防止双花攻击。以下是一个简单的例子:

1. 用户 A 获得铸币权,发行 10 个比特币(铸币交易)
2. A 将 10 个比特币分别转给 B 和 C 各 5 个比特币

   - 需要 A 的签名
   - 需要指明币的来源(铸币交易)
   - 需要指定 B 和 C 的公钥哈希作为收款地址

3. B 将 5 个比特币分配给 C(2 个)和 D(3 个)

   - 需要 B 的签名
   - 需要指明币的来源(A 的转账交易)
   - 需要指定 C 和 D 的公钥哈希

4. C 现在拥有 7 个比特币(从 B 获得 2 个,从 A 获得 5 个),可以将这 7 个比特币转给 E
   - 需要 C 的签名
   - 需要指明两个币的来源(从 A 和 B 的交易)

每笔交易都包含:

- 输入:说明币的来源
- 输出:指定收款人的公钥哈希
- 发送方的签名

通过这种链式结构和交易记录,可以追踪每个比特币的流向,有效防止双花攻击。

区块链中有两种哈希指针:

1. 连接区块之间的哈希指针,形成链表结构
2. 指向前序交易的哈希指针,用于追踪币的来源

这种设计有两个重要作用:

1. 证明币的合法性 - 通过追踪来源,确保币不是凭空产生
2. 防范双花攻击 - 当 B 试图将已经转给 C 和 D 的 5 个比特币再次转给 F 时,其他节点可以通过回溯交易历史,发现这 5 个比特币已经被使用,从而拒绝这笔非法交易

通过这种机制,区块链可以有效地检测和防范双花攻击,保证交易的合法性。

### 比特币转账交易信息需求

比特币转账交易需要包含以下关键信息:

1. 转账发起方(A)信息:

   - A 的公钥(用于验证签名)
   - A 的签名
   - 币的来源证明(指向前序交易)

2. 接收方(B)信息:
   - B 的公钥哈希(地址)

### 比特币转账交易验证机制

- 转账发起方的公钥必须与币来源交易中指定的公钥哈希匹配
- 所有节点都需要验证交易签名的合法性
- 通过哈希指针验证币的来源,防止伪造

这种设计确保了交易的安全性和真实性,有效防止了伪造和冒充行为。

比特币系统中的交易验证是通过执行脚本实现的:

- 每个交易的输入和输出都是一段脚本
- 验证时将当前交易的输入脚本与前序交易的输出脚本拼接执行
- 脚本执行无错误则说明交易合法

### 区块结构详解

区块结构包含两部分:

1. 区块头(Block Header):

   - 比特币协议版本
   - 前一个区块的哈希指针(只指向前一个区块的区块头)
   - Merkle 树根哈希值
   - 挖矿难度目标值
   - 随机数(Nonce)

2. 区块体(Block Body):
   - 包含多个交易
   - 交易以 Merkle 树形式组织
   - 通过区块头中的 Merkle 根哈希保证交易列表不可篡改

### 全节点与轻节点

比特币网络中的节点分为两类:

1. 全节点(Full Node)

   - 保存完整的区块链信息
   - 可以验证所有交易(Fully Validating Node)
   - 参与区块链的构造和维护
   - 数量较少

2. 轻节点(Light Node)
   - 仅保存区块头信息
   - 无法独立验证交易合法性
   - 只能进行查询操作
   - 占系统中大多数节点

### 分布式共识的挑战

区块链作为去中心化账本,需要所有节点就账本内容达成共识。主要挑战包括:

1. 交易打包的一致性

- 每个节点都可以发布和打包交易
- 需要确保交易不会重复打包
- 不同节点间的区块链内容必须保持一致

2. 分布式系统理论限制

- FLP impossibility result:在异步系统中,即使只有一个故障节点也无法达成共识
- CAP 定理:一致性(Consistency)、可用性(Availability)、分区容错性(Partition tolerance)三者最多只能同时满足两个
- Paxos 等共识协议可以保证一致性,但在某些情况下可能无法达成共识

3. 实际应用考虑

- 分布式共识在理论研究上有很多限制
- 比特币系统需要一个实用的共识机制
- 需要考虑恶意节点的存在

### 比特币中的共识协议

比特币共识协议需要解决恶意节点的问题。虽然系统中大多数节点是好的,但简单的投票机制存在以下问题:

1. 投票权的确定问题

- 比特币系统中账户创建非常容易
- 恶意节点可以通过创建大量账户进行女巫攻击(Sybil Attack)
- 无法通过简单计数投票达成共识

2. 其他技术问题

- 节点可能拒绝参与投票
- 网络延迟导致效率低下
- 恶意节点可能不断提出非法区块

比特币系统采用了一个巧妙的基于计算力的投票机制来解决共识问题:

1. 节点通过解决计算难题(computational puzzle)来争夺记账权:

   - 每个节点组装候选区块并尝试不同的 nonce 值
   - 找到符合难度要求的 nonce 值即获得记账权
   - 可以发布新区块到区块链中

2. 其他节点验证新区块的合法性:

   - 验证区块头(block header)各个域是否符合要求
   - 验证难度值是否符合协议规定
   - 验证区块内所有交易的合法性

3. 区块的接受规则:
   - 区块必须扩展最长合法链
   - 不接受插入到链中间的区块(防止分叉攻击)
   - 当出现等长分叉时,节点接受最先收到的分叉
   - 通过在分叉上继续扩展来隐式确认区块

这种机制通过计算力投票而不是账户数量投票,有效避免了女巫攻击等问题。同时通过最长链原则来解决临时性分叉,保证了系统的一致性。

### 区块链的分叉问题

1. 分叉攻击

- 恶意节点可能在区块链中间插入区块造成分叉
- 这种分叉可能导致交易回滚
- 比特币协议规定只接受扩展最长合法链的区块

2. 临时性分叉

- 两个节点同时获得记账权时可能产生等长分叉
- 节点默认接受最先收到的分叉
- 通过继续在分叉上扩展区块来隐式确认
- 最终较长的分叉会胜出,较短的分叉成为孤块被丢弃

### 区块链的分叉处理机制

1. 节点接受规则

- 默认接受最早收到的区块
- 通过在区块上继续扩展来隐式确认
- 等长分叉会维持一段时间,直到某个分叉胜出
- 较短的分叉成为孤块被丢弃

2. 出块奖励机制

- 获得记账权的节点可以发布特殊的铸币交易(coinbase transaction)
- 这是比特币系统中发行新币的唯一途径
- 获得记账权的节点可以决定区块中包含的交易
- 孤块上的出块奖励将失效

### 比特币的发行机制

1. Coinbase 交易

- 是比特币系统中发行新币的唯一途径
- 不需要指明币的来源
- 其他交易只是在账户间转移已有比特币

2. 出块奖励机制

- 初始每个区块奖励 50 BTC
- 每 21 万个区块减半一次
- 目前奖励为 12.5 BTC
- 现在每个区块奖励约值 8 万美元
- 丰厚奖励激励大量节点竞争记账权

3. 历史发展

- 早期竞争较少,获得奖励相对容易
- 比特币最初价值很低(2 万 BTC 曾换一个比萨)
- 现在竞争激烈,需要大量计算资源
- 虽然奖励数量减少,但币值大幅上涨

### 孤块与区块奖励

当区块链出现分叉时,较短的分叉会成为孤块,其中的区块奖励(coinbase 交易)将失效。这是因为比特币协议要求接受最长合法链,孤块上的交易不会被诚实节点接受。

### 比特币共识机制

比特币系统的共识机制主要关注去中心化账本的内容。只有获得记账权的节点才能向账本写入内容,而记账权通过解决计算难题(puzzle)获得。由于 puzzle friendly 特性,节点获得记账权的概率与其算力(hash rate)成正比。

### 防范女巫攻击

比特币通过算力投票而非账户数量投票来防范女巫攻击(Sybil attack)。因为创建多个账户并不会增加节点的 hash rate,所以无法通过创建大量账户来操纵投票。

### 挖矿机制

争夺记账权的过程被形象地称为"挖矿",这源于比特币被视为"数字黄金"。矿工通过解决计算难题(寻找合法 nonce)来获得记账权和比特币奖励。这个过程类似于历史上的淘金热:

- 需要大量资源投入
- 成功概率较低
- 一旦成功可获得丰厚回报

这种挖矿机制是比特币系统共识机制的核心组成部分。
