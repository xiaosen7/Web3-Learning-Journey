北京大学肖臻老师《区块链技术与应用》公开课\_原文
2024 年 10 月 25 日 17:33
发言人 00:05
今天我们讲一下比特币系统中如何调整挖矿难度。挖矿就是不断尝试 block header 里的 nonce 值，使整个 block header 的哈希值小于等于给定的目标阈值。

发言人 00:40
目标阈值越小，挖矿难度越大。调整挖矿难度就是调整目标空间在整个输出空间中所占的比例。比特币使用的哈希算法是 SHA256。SHA256 产生的哈希值是 256 位，所以整个输出空间是 2 的 256 次方。调整这个比例，目标空间占输出空间的比例，有时通俗地说就是哈希值前面有多少个 0。例如，256 位的哈希值，如果合法的区块要求算出来的哈希前面至少有 70 个 0。

发言人 01:46
当然，这是一种通俗的说法，不是特别准确。因为目标阈值并不是说前面都是零，从某个位置开始后面就都变成一了，它不是这样。所以严格来说，还是按照定义来看这个问题。我们听到的另一个概念是挖矿难度，挖矿难度与目标阈值成反比。

发言人 02:51
挖矿难度为 1 时，对应的目标阈值是一个非常大的数，意味着寻找满足条件的哈希值相对容易。用这个很大的数除以当前的目标阈值，得到的就是当前的挖矿难度，所以这两者是成反比的。

发言人 03:36
那我们为什么要调整挖矿难度呢？如果不调整，系统里的总算力越来越强，出块时间会越来越短。一开始没有多少人参与比特币游戏，可能按照设计是十分钟出一个区块。后来参与的人多了，变成一分钟出一个区块。再后来，挖矿的人越来越多，设备越来越先进，可能只要 10 秒钟就出一个区块，甚至不到一秒就出一个区块。出块时间会越来越短。

发言人 04:28
有的人可能觉得这是好事，出块时间越来越短，发布一个交易很快就能被写到区块链里，提高了系统的响应时间，增加了系统的舒适度。但如果真是好事，我们就没必要把出块时间设计成十分钟。出块时间太短会有什么问题吗？

发言人 05:29
比如说不到一秒钟就出一个区块，这个区块在网络上传播的时间可能需要几十秒。比特币网络可能要几十秒才能让其他节点都收到。在其他节点没有收到这个区块之前，还是继续沿着已有的区块链往下扩展。如果有两个节点差不多同时收到这个区块，也差不多同时发布了一个区块，那么就会出现分叉。

发言人 06:22
如果两个节点同时挖到矿，这两个区块同时被发布出来，就会出现一个二分叉。出块时间如果越来越短，这种分叉会成为常态，甚至可能出现很多分叉。如果有十个区块差不多同时被挖出来，系统中会出现一个十分叉。

发言人 07:22
分叉过多对于系统达成共识没有好处，也危害系统的安全性。比特币协议假设大部分算力掌握在诚实矿工手里，系统总算力越强，安全性越好。因为发动 51%攻击所需的算力就越大。51%攻击是指恶意节点掌握系统中 51%以上的算力，这时他就可以干各种坏事。

发言人 08:11
比如我们前面讲过的分叉攻击。在某个区块里有一个转账交易，A 转给 B 一大笔比特币。假设在后面跟着六个确认区块，B 认为这个转账交易已经成功了。这时 A 从这个地方开始分叉，要回滚这个交易，把钱转给自己。

发言人 08:56
正常情况下，这个攻击难度比较大。如果大部分算力掌握在诚实矿工手里，要让这个链比上面那个链还要长，难度比较大。但如果出现很多分叉，系统总算力就被分散了。比如在这个例子中，假设出现十分叉，节点根据在网络中的位置不同，可能会选择沿着某个分叉继续拓展。而恶意节点可以集中算力扩展它的分叉。

发言人 09:57
这样很快就可以使这个分叉变成最长合法链。因为好人的算力被分散，这时可能不需要 51%的算力就能发动攻击，可能 10%几的算力就够了。所以出块时间不是越短越好。

发言人 10:22
当然，出块时间不是越短越好。那么比特币协议中设计的十分钟出块间隔是最优的吗？不一定。比如改成八分钟或五分钟行不行？应该也是可以的。出块时间要有一个常数的波动范围，不能无限减小。

发言人 10:56
有些人觉得比特币中的十分钟出块间隔有点太长。对于一个支付系统来说，做一个支付要等那么长时间才能得到确认，这个时间有点太长。我们后面会讲到以太坊，以太坊的出块时间降低到了 15 秒，所以以太坊的出块速度是比特币的 40 倍。出块时间大幅度下降后，以太坊设计了一个新的共识协议叫 GHOST。

发言人 11:40
在这个协议中，这些分叉产生的区块不能简单丢弃，而是要给它一些奖励，这叫做 uncle reward。

发言人 12:17
关于以太坊的具体运行情况，我们后面的课会讲。这里强调一点，以太坊同样需要调整挖矿难度，使出块时间保持稳定。降到 15 秒后，这个 15 秒也要设法保持稳定。所以平均出块时间设计成多长没有一定之规，但不论设计成多长，都需要保持稳定，不能无限减小。大家有问题吗？

发言人 13:41
好，我们讲了为什么要调整挖矿难度。下面讲一下具体怎么调整。比特币协议规定每隔 2016 个区块重新调整目标阈值。大概是每两个星期调整一次。2016 个区块，每个区块十分钟，一个小时 60 分钟，一天 24 小时，大概是 14 天。具体怎么调整呢？按照这个公式。

发言人 15:02
这是目标阈值迭代更新的方法。expected time 是 2016 乘以十分钟，就是两个星期。如果理想状况下每十分钟产生一个区块，产生 2016 个区块就需要这么多时间，这是预期时间。actual time 是系统中产生最近 2016 个区块实际花费的时间。

发言人 16:03
公式的意思是，如果实际时间超过两个星期，说明平均出块间隔超过十分钟，这时挖矿难度应该调低一点，让出块更容易。公式中这部分大于一，所以乘完之后会变大。因为成反比，目标阈值变大后，挖矿难度就降低了。

发言人 16:48
如果实际时间小于两个星期，说明出块速度太快，这时应该提高挖矿难度。公式中这部分小于一，所以算出来的值变小，相当于挖矿难度提高了。

发言人 17:17
实际代码中，上调和下调都有四倍的限制。比如实际时间非常长，超过八个星期，正常应该是两个星期，超过八个星期时算的时候也只按八个星期算。目标阈值增大最多增大四倍，不会一次性超过四倍。主要是为了避免系统中出现意外情况，导致目标阈值有特别大的波动。相反，如果实际时间非常短，不到半个星期就产生了 2016 个区块，这时也按半个星期算。目标阈值最小减小四倍，不会一次性减小特别多。这就是调整目标阈值的方法。

发言人 18:45
那怎么才能让所有矿工同时调整目标阈值？因为这是去中心化的系统，怎么能让大家都听话同时调整？计算目标阈值的方法写在比特币系统的代码里，每挖到 2016 个区块，系统会自动调整。代码是开源的，如果有恶意节点故意不调整会怎么办？大家明白这个问题吗？

发言人 19:54
如果不调整，发布的区块诚实矿工不会认。大家还记得我们讲 block header 的结构吗？有一个字段是 target 的编码版本，block header 里没有直接存储目标阈值，因为目标阈值是 256 位，直接存需要 32 个字节。block header 里的字段只有四个字节，可以认为是它的压缩编码。

发言人 20:43
如果有恶意矿工该调时不调，检查区块合法性就通不过。每个节点要独立验证发布区块的合法性，检查内容包括目标阈值设定是否正确。如果投机取巧设一个过大的目标阈值，使自己挖矿容易，但别人算出来设定不对，这个区块不会被接受。

发言人 21:19
大家觉得比特币调整难度的方法复杂吗？其实比较简单。我们后面讲到以太坊时会看到，以太坊也要定期调整挖矿难度，但它的定期不是隔多少个区块，而是每个新出的区块都有可能调整，调整方法也比这里讲的复杂得多。有问题吗？

发言人 22:03
是经验阈值，还是事先经过论文发表？我觉得中本聪可能自己拍脑袋想的，也不叫拍脑袋想。他根据过去的研究和调研选的这些参数。有人觉得没有买比特币特别可惜，因为比特币当初那么便宜。现在回过头看，比特币是一个伟大的发明，但在比特币之前有很多加密货币都失败了。比特币出现之前大概有 20 年的研究，研究各种加密货币，最后都不行。

发言人 22:50
比特币成功并不是因为它更实用，从某种意义上说是因为它更不实用。以前失败的加密货币设计成现实货币的电子支付渠道，比特币没有任何真正法币背书，没有底下的保证金，完全是凭空造的货币。

发言人 23:31
中本聪设计这些加密货币时，里面有很多参数。出块时间设成十分钟是不是最好的，有争议。每个块最多一兆字节是否合适，还有为什么是 2016 个区块调一次。以太坊里每个区块都可以调。这些参数是中本聪从哪些论文里得到的验证参数吗？是经验参数吗？我觉得他可能看过一些调研，也经过思考选的这些参数，总的来说还是比较合理的。

发言人 24:18
但是否最优有争议。比特币系统设计总的来说比较保守。从区块时间、区块大小、支持的脚本语言来说都很保守。比特币社区的支持者也比较保守，可能因为自己有很多比特币，不愿意危及自己的财富，所以改动很难。这也是为什么后面有以太坊和各种新的加密货币。参数是否经过严格论证，我不知道，也可能是他自己想的比较合理。有别的问题吗？

发言人 25:12
没有问题的话，我们看一下比特币系统中的一些实际情况。

发言人 25:52
这张图显示了比特币系统中总算力的变化情况。在比特币没有流行起来之前，有很长一段时间算力没有太明显的增长。前面这些年的 hash rate 看上去几乎是零，贴着 X 轴。其实这些年算力也是在增长的，只不过后面这几年算力增长太快了，所以前面这部分看上去像是一条直线。去年是加密货币涨得非常猛的一年，这也体现在了 hash rate 的增长上。这部分曲线是从去年年初到现在，我们可以看到算力呈现出指数级的增长。注意即使在这段黄金时期，算力也不是单调递增的，中间有很多波动，但总的来说增长非常快。

发言人 27:00
这是挖矿难度的变化情况，跟算力的增长基本同步，这也符合难度调整的设计目标，通过调整挖矿难度使出块时间保持稳定。注意这个图显示的是挖矿难度，不是目标阈值。这是最近半年的难度调整曲线，可以看出每隔两个星期难度上一个台阶，说明挖矿的人越来越多，设备越来越先进，反映出大家对比特币的热情越来越高。如果出现相反情况，比如某个加密货币的挖矿难度越调越小，说明挖矿变得越来越容易，但这不是好事，说明大家对这个币的热情逐渐减少。如果持续出现这种情况，一般来说这个币就慢慢不行了。

发言人 28:14
这个图显示的是每天的出块时间。从 2010 年到现在我们可以看到，总的来说出块时间稳定在十分钟上下波动，说明难度调整达到了预期目的。这是最近半年的出块时间，也是按天做的，平均维持在十分钟左右。最后这些 PPT 是咱们这门课用的教科书配套的一页。PPT 上给出了调整挖矿难度的公式，大家看看这个公式跟我们课上给出的公式有什么区别。

发言人 29:13
这个地方正好是反过来的。它这个是 difficulty time，分子分母是实际时间。这两个公式都是对的。他这里算的是挖矿难度，我们这里算的是目标阈值，这是一个容易引起混淆的地方。大家看到这种公式时注意一下，因为这两者是成反比的。看清楚他到底算的是挖矿难度还是目标阈值。实际比特币代码里用的是目标阈值。好了，这部分我们就讲到这里。
