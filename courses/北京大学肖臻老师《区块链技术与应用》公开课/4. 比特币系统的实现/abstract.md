北京大学肖臻老师《区块链技术与应用》公开课 (1)\_原文
2024 年 10 月 25 日 14:11

### 比特币系统的账本模式与 UTXO 数据结构

比特币系统采用基于交易的去中心化账本模式。区块链中每个区块记录交易信息，包括转账和铸币交易，但不直接记录账户余额。账户余额需要通过追踪该地址的所有交易记录来计算。

为了验证交易合法性和防止双重支付，比特币系统的全节点维护着一个称为 UTXO(未花费交易输出)的数据结构。UTXO 集合包含所有未被花费的交易输出，每个输出都由交易哈希值和输出序号来标识。当新交易发生时，系统会检查交易输入是否存在于 UTXO 集合中，以此验证交易的合法性。

随着交易的进行，UTXO 集合会动态更新 - 新交易会消耗一些 UTXO 并产生新的输出。虽然 UTXO 集合规模在不断增长(因为一些比特币永久未被使用)，但目前仍可轻松存储在普通服务器内存中。

### 比特币交易的输入输出与交易费机制

比特币交易支持多输入多输出模式。每笔交易的输入金额总和必须等于输出金额总和。由于输入可能来自不同地址，因此一笔交易可能需要多个签名验证。

### 交易费与矿工激励机制

比特币系统设计了双重激励机制来鼓励矿工:

1. 出块奖励(Block Reward) - 矿工获得记账权后可获得新铸造的比特币
2. 交易费(Transaction Fee) - 交易输入与输出的差额作为矿工打包交易的报酬

这种双重激励机制可以防止矿工只打包自己的交易。目前交易费相对较低(约 0.01 BTC 或更少),矿工主要依靠出块奖励(12.5 BTC)获利。

### 出块奖励的衰减机制

比特币系统每 21 万个区块(约 4 年)将出块奖励减半:

- 系统设计平均每 10 分钟出一个区块
- 21 万个区块约等于 4 年时间
- 随着时间推移,出块奖励会逐渐减少
- 未来交易费可能成为矿工的主要收入来源

### 比特币与以太坊账本模式的对比

比特币采用基于交易(Transaction-based)的账本模式:

- 需要指明币的来源
- 隐私保护性较好
- 需要通过交易记录计算余额

以太坊采用基于账户(Account-based)的模式:

- 直接记录账户余额
- 类似传统银行账户
- 无需指明币的来源
- 操作更简便直观

### 区块内容与挖矿机制分析

#### 区块内容与奖励

一个实际区块的例子包含 686 个交易。区块中包含总输出比特币数量和交易费。出块奖励约为交易费的 100 倍,是矿工的主要收入来源。

#### 区块结构与难度

区块包含序号(hit)、时间戳(Tim stem)、挖矿难度(Difficult)和随机数(Nance)等字段。挖矿难度每 2016 个区块调整一次,以维持约 10 分钟的出块时间。区块头的哈希值和前一区块哈希值都以一长串零开头,这是由于挖矿难度要求导致。

#### 挖矿过程优化

由于 32 位 nonce 提供的搜索空间(2^32)不足以应对当前高难度,矿工会利用 coinbase 域的前 8 字节作为额外随机数(extraNonce),将搜索空间扩大到 2^96。通过改变 coinbase 内容可以影响 merkle root 哈希值,从而实现两层循环搜索。

#### 交易结构示例

文中展示了一个包含两个输入和两个输出的转账交易示例。输入引用了之前交易的未使用输出(UTXO),输入总额与输出总额的差值即为交易费。交易使用脚本形式指定输入输出。

### 比特币交易验证与挖矿机制分析

比特币交易验证通过配对输入脚本和前一交易的输出脚本来完成。验证过程是将两个脚本拼接并执行,若执行无误则交易合法。

关于 PPT 内容的一个重要澄清:区块的哈希计算仅包含区块头(block header)信息,而不包含具体交易信息。区块头中只包含 merkle tree 根哈希值,这足以保证区块中的交易不被篡改。

挖矿过程可以视为一系列伯努利试验(Bernoulli trials),每次尝试都是独立的随机事件。由于成功概率极小且试验次数巨大,这个过程可以用泊松过程(Poisson process)来近似。系统的出块时间服从指数分布,平均维持在 10 分钟,且具有无记忆性 - 即未来出块时间不受过去已尝试时间的影响。

这种无记忆特性(progress-free)看似不合直觉,但实际上是确保挖矿公平性的重要机制。它保证了矿工获得记账权的概率与其算力成正比,防止算力较强的矿工获得不成比例的优势。

### 挖矿过程的概率分析

挖矿过程可以视为一系列伯努利试验(Bernoulli trials),类似于掷硬币实验。每次尝试都是独立的随机事件,成功概率极小。大量独立试验构成泊松过程(Poisson process),具有无记忆性(memoryless property) - 即过去的尝试结果不影响未来的成功概率。

系统的出块时间服从指数分布,平均维持在 10 分钟。这种无记忆特性看似不合直觉,但实际上是确保挖矿公平性的重要机制。如果没有这个特性,算力强的矿工会获得不成比例的优势。目前的设计确保了矿工获得记账权的概率与其算力成正比,从而维持了系统的公平性。

每个矿工的出块时间取决于其算力占总算力的比例。例如,一个拥有 1%算力的矿工平均需要 1000 分钟(约 16.7 小时)才能挖到一个区块。这种基于算力的概率分配机制是比特币系统公平性和安全性的重要保障。

### 比特币总量分析与挖矿机制

#### 比特币总量计算

比特币通过出块奖励产生新币,每 4 年(21 万个区块)减半一次。初始奖励 50 BTC,构成几何级数:

- 第一个 21 万个区块: 50 BTC/区块
- 第二个 21 万个区块: 25 BTC/区块
- 第三个 21 万个区块: 12.5 BTC/区块
- 以此类推

通过计算这个几何级数,可得出比特币最终总量为 2100 万个。

#### 挖矿机制说明

挖矿并非解决特定数学难题,而是纯粹的算力竞争。比特币变得越来越难获得是因为出块奖励的人为减半,而非问题难度增加。虽然挖矿过程本身看似无意义,但对维护系统安全性至关重要,通过算力投票机制保证系统安全。

#### 挖矿激励机制

尽管出块奖励逐渐减少,但由于比特币价格上涨,挖矿竞争反而更加激烈。即使在出块奖励趋近于零时,交易费用将成为矿工的另一个重要收入来源,继续维持挖矿积极性。

### 比特币安全性分析

#### 恶意节点的交易篡改

- 即使恶意节点获得记账权,也无法伪造他人签名进行转账
- 包含非法交易的区块会被诚实节点拒绝,导致分叉
- 攻击者会损失出块奖励,代价高昂

#### 双重支付攻击(Double Spending)

- 攻击者试图将已花费的比特币再次使用
- 需要在原交易区块前创建分叉
- 成功概率取决于攻击者的算力占比
- 常见于网购等场景,试图回滚已完成的支付

#### 交易确认机制

- 一个确认:交易刚被写入区块
- 六个确认(约 1 小时):比特币默认的安全确认数
- 区块链的不可篡改性是概率性的保证
- 确认数越多,交易被篡改的可能性呈指数级下降

#### 零确认交易(Zero Confirmation)

- 交易已广播但未被写入区块
- 节点倾向接受最先收到的交易版本
- 在实际应用中较为普遍
- 适用于有自然处理延迟的场景(如网购发货)

#### 其他攻击形式

- 恶意节点可以选择性忽略某些合法交易
- 被忽略的交易可由后续诚实节点处理
- 自私挖矿(Selfish Mining)可能带来一定优势
- 但需要较强算力支持,风险也相应较大

### 区块大小限制与交易处理

区块链在正常运行时,由于区块大小限制(最大 1MB),可能出现合法交易无法及时被打包的情况。这些交易需要等待下一个区块才能被处理。

### 预挖矿攻击与 Selfish Mining

一位同学提出了预先计算未来区块的攻击方案,但这种方案不可行,因为每个区块都需要前一个区块的哈希值。相反,Selfish Mining 是一种可行的攻击策略,攻击者先不发布挖到的区块,而是继续挖掘,等待合适时机一次性发布多个区块。

### Selfish Mining 的原理与风险

- 正常挖矿:矿工应立即发布新区块,否则可能失去出块奖励
- Selfish Mining 策略:
  - 暂不发布挖到的区块
  - 继续在私密链上挖矿
  - 在合适时机发布多个区块
- 成功条件:需要较强算力支持(接近 51%)
- 风险:如果私密链最终比公共链短,将损失所有投入

### Selfish Mining 的潜在收益

通过延迟发布区块,Selfish Mining 可以:

- 减少其他矿工的有效竞争
- 让其他矿工浪费算力在已过时的区块上
- 获得更多的出块奖励机会
  但这种策略风险较大,收益也不够显著。

### Selfish Mining 的额外目的与策略分析

#### 延迟发布的策略优势

- 通过不立即发布已挖出的区块,可以让其他矿工继续在旧链上浪费算力
- 当拥有足够算力时,可以在私密链上连续挖出多个区块
- 在合适时机发布多个区块,使其他矿工的工作作废
- 这种策略可以减少有效竞争,提高获得出块奖励的机会

#### 策略风险与局限性

- 如果未能及时在私密链上挖出下一个区块,可能与公共链形成等长竞争
- 需要在这种情况下迅速发布区块以争取优势
- 如果私密链最终落后于公共链,所有投入将付诸东流
- 总体而言,收益相对有限,风险较大

#### 课程小结

本节课完成了比特币系统具体实现的讲解,后续将围绕比特币系统的其他方面进行专题式介绍。
