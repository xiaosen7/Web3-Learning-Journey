## 00:00:05 - 00:01:00 比特币系统中的密码学原理

我们先讲解比特币系统中涉及的密码学原理。比特币被称为加密货币，但实际上加密货币并不进行加密。转账金额都是公开的。比特币主要采用了密码学中的两个功能：哈希和签名。大家应该都比较了解哈希函数的工作原理。密码学中使用的哈希函数被称为 cryptographic hash function。

## 00:01:20 - 00:05:02 哈希函数的两个重要性质

它有两个重要的性质，一个叫做 collision resistance。这个地方的 collision 是指哈希碰撞。如果有两个输入，x 和 y，x 不等于 y，但是呢比如说我们的哈希函数叫 h，算出来的 h(x) 等于 h(y)，那么这就叫做哈希碰撞。两个不同的输入算出来的哈希值是相等的。哈希碰撞呢是很常见的。像我们使用哈希表的过程中，就会遇到哈希碰撞。不同的输入，可能会被映射到哈希表当中的同一个位置。一般来说呢哈希碰撞是不可避免的。因为输入空间是远远大于输出空间的。比如说我们有一个 256 位的哈希值。那输出空间有多大呢。所有哈希值的取值可能性，就是二的 256 次方。输出空间就只有这么大。但是输入空间可以是无限大的。所以它是有任意多种输入的可能性。按照鸽巢原理的话，必然会出现有两个输入，被映射到同一个输出的情况。所以我们这里说的 collision resistance，并不是说不会出现哈希碰撞。有的书上管这个性质叫做 collision free，这个说法我不是特别喜欢。因为它容易给人造成误解，好像是碰撞不会发生。实际上碰撞是客观存在的。它这个意思是什么呢。是说没有什么高效的方法。人为地去制造哈希碰撞。就给定了一个 x，没有什么好办法，你能找到另外一个 y，使得 x 和 y 的哈希值恰好相等。就你没有什么高效的方法去找。你硬要找的话，可以用蛮力求解的方法。比如说这个 x 和这个 y，你就遍历所有输入的可能性，然后看看哪一个算出来的哈希值正好相等。这种叫做 brute force。遍历输入的所有可能取值。最后找到一个哈希值碰撞在一起的。但是如果这个输入空间比较大，比如说是对于一个哈希值，是 256 位的话。实际上你要用这种方法去找的话，在实际中是不可行的。它的工作量实在是太大了。那么 collision resistance 这个性质有什么用呢。

### 补充

鸽巢原理（也称为抽屉原理）是一个简单但强大的数学概念。它可以这样解释：

1. 基本概念：如果你有 n 个物品要放入 m 个容器中，且 n > m，那么至少有一个容器会包含多于一个物品。
2. 形象比喻：如果你有 10 只鸽子要放入 9 个鸽笼中，那么必定至少有一个鸽笼会有多于一只鸽子。
3. 在哈希函数中的应用：
   输入空间（可能的输入值）通常远大于输出空间（可能的哈希值）。
   比如 256 位的哈希值，输出空间大小为 2^256，但输入可以是任意长度的数据。
   根据鸽巢原理，必然存在不同的输入会产生相同的哈希值（即发生碰撞）。
4. 重要性：
   说明了哈希碰撞的不可避免性。
   解释了为什么完全避免碰撞是不可能的，只能追求碰撞难以人为制造。
5. 在密码学中的意义：
   帮助理解哈希函数的设计目标不是完全消除碰撞，而是使碰撞难以被利用。
   强调了大输入空间对于哈希函数安全性的重要性。
   总之，鸽巢原理在密码学中帮助我们理解哈希函数的基本限制，并指导我们设计更安全的加密系统。

## 00:05:07 - 00:06:51 哈希函数在检测数据篡改中的应用

它可以用来对一个消息求摘要。比如说我们有一个消息叫 m，我们取它的哈希值 h(m)，这个哈希值可以认为是这个消息摘要。用来检测对这个消息的篡改。比如说如果有人改这个消息的内容，它的哈希值就会发生变化。那么这个碰撞阻力性质，就是说你找不到另外一个 m'，使得这个 m' 取哈希之后，跟原来的哈希值恰好相等。所以没有办法能够篡改内容，而又不被检测出来。比如说你有一个很大的文件，你想把它存放到某个云存储服务上，将来你用到的时候再把它下载回来，那么你怎么知道你下载的版本，跟你当初上传的版本是一样的呢？这就可以用到这个哈希函数的这个碰撞阻力性质。在你上传这个文件之前，先算一个哈希值出来。这个哈希值存在本地。将来你下载之后，再算一个哈希值，跟原来你存的哈希值比较一下。如果是一样的话，说明下载的还是原来那个当初的版本。这就是碰撞阻力的一个用处。请注意，没有哈希函数能在数学上证明是碰撞抵抗的。我们刚才讨论了这一点，理论上来讲，这是无法证明的。这只能依靠实践中的经验。有些哈希函数经过长期的实践检验，世界上有那么多密码学的专家，谁也没有能够找到人为制造哈希碰撞的方法。所以我们认为这些哈希函数是碰撞抵抗的，这就是实践经验。也有一些哈希函数，以前我们认为是碰撞抵抗的，但后来大家找到了制造哈希碰撞的方法。一个很著名的例子就是 MD5。MD5 曾经是个很流行的哈希函数，大家原来以为它很安全，但现在不行了，我们已经知道怎么去人为地制造哈希碰撞。

## 00:07:06 - 00:10:03 哈希函数的 hiding 性质

密码学用的哈希函数还有第二个性质叫做隐藏性(hiding)。隐藏性是指哈希函数的计算过程是单向的，是不可逆的。给定一个输入 x，可以算出它的哈希值 h(x)，但从这个哈希值 h(x) 无法反推出原来的输入 x。换句话说，这个哈希值没有泄露有关这个输入的任何信息，这叫做隐藏性。当然，如果你想一想，如果你想要知道这个输入的话，也是有办法的。怎么办？还是用那种遍历的方法，我把这个输入所有可能的取值遍历一遍，看看哪个哈希值跟这个相等。这就是我能猜出来原来的输入是什么。所以蛮力求解是一种办法。隐藏性这个性质成立的前提是，这个输入空间要足够的大。

## 00:10:03 - 00:10:29 蛮力求解方法的不可行性

这使得暴力破解方法不可行，各种取值的可能性大致相同。如果输入空间虽然很大，但在大多数情况下，取值都集中在少数几个值上，那么也容易被破解。

## 00:10:33 - 00:11:17 hiding 性质的用途

隐藏这个性质有什么用呢，它可以和这个碰撞抵抗性质结合起来实现 digital commitment。这种承诺有时也被称作 digital equivalent commitment。

## 00:11:40 - 00:14:22 现实生活中的 sealed envelope

我们先说一下现实生活中，sealed envelope 是干嘛用的。比如说有一个人说他能够预测股市，可以预测第二天哪些股票会涨停。那怎么证明这个人预测的是不是准确呢？一种办法是，这个人提前一天在电视台上公布预测结果，我预测明天某某股票会涨停的。第二天收盘之后呢，看一下这个股票是不是真的涨停。就知道预测准不准了。这样做有什么问题吗？这好像是一种检验预测准不准的方法，有什么问题吗？实际上会可能会受这些话影响，刚才那个同学说的对，如果你预测结果提前公布了。可能会影响股市。就比如说这个人很有名气，大家觉得这是个股神，本来这只股票不会涨停的，他这么一公开预测。大家拼命去买，结果它变成了涨停。当然了，反方向的情况也可能发生，就这支股票也许本来确实是要涨停的，有人想踢场子。你不是预测它涨停吗，我就不让它涨停，拼命的砸盘，这都有可能发生，这说明一个什么道理，预测结果不能够提前公开。但是如果预测结果不提前公开，你等第二天收盘之后再公开，那你怎么知道这个预测结果，有没有被篡改过，你最后公开的结果。是不是你提前一天做出来的，这个就要用到我们说的叫 sealed envelope，你把你的预测结果写在一张纸上，放到一个信封里给封好了，这个信封要交给第三方的公证机构保管，等第二天收盘之后再把它打开。验证一下这个结果准不准，大家听明白了吗，就现实生活中，sealed envelope 就是这个意思，那在电子世界里呢。

## 00:14:23 - 00:16:33 电子世界中的 sealed envelope

我要有一个 digital sealed envelope，我怎么实现呢，把这个预测结果作为输入 x。算出一个哈希值来，然后把这个哈希值可以公布出去，因为我们有这个 hiding 的性质，所以你从这个哈希值，不知道预测结果是什么，然后第二天收盘之后呢。我再把预测结果公布出去，因为有这个碰撞抵抗性质，所以我这个预测结果是不可能篡改的，你要是改的话，就跟当初公布的这个哈希值是对不上了，大家听明白了吗，实际操作中呢有一些细节要注意。就我们说 hiding 这个性质的前提是什么，输入空间要足够大，如果这个输入不满足这个性质，像我举的这个例子当中，预测第二天哪只股票会涨停。那股票一共就那么几千只对吧，输入空间不是足够的，那么常用的方法是把这个输入后面，拼接一个随机数，然后再一起去哈希就是这个时候不是 x，x 后面拼一个随机的，叫 nonce，然后整个去哈希，这个 nonce 是我们选取的一个随机数保证，这样拼接之后，整个输入是足够随机的，这实际中操作要注意的一些细节。大家有什么问题吗。

## 00:16:55 - 00:19:59 比特币中的哈希函数特性

除了密码学中要求的这两个性质之外，比特币中用到的哈希函数还要求第三个性质，叫作 puzzle friendly。这个意思是说，哈希值的计算事先是不可预测的。你光是看这个输入，很难猜出来它最后的哈希值是什么。所以，如果你想要你算出来的哈希值是落在某个范围之内的，那没有什么好的办法，你就只能是一个一个输入去试，看哪个输入算出来恰好是落在要求的那个范围之内。比如说，你想得到一个哈希值，前面 k 位都是零。你要这样的哈希值，前面是一串零，后面可以是任意的，整个是 256 位的，必须以 k 个零开始。那什么样的输入会算出这样的哈希值呢？不知道。这个 puzzle friendly 性质是说，你事先是不知道的，哪个输入更有可能算出这个哈希值来。那你要得到这个哈希值，就一个一个去试，没有什么捷径。这个性质为什么叫 puzzle friendly？后面我们讲到比特币这个挖矿的过程，大家可能听说过挖矿这个词。挖矿实际上就是找一个 nonce，找这么一个随机数。这个 nonce 呢，和区块的块头里的其他信息合在一起作为输入，取出一个哈希来。那个哈希值要小于等于某个指定的目标阈值。就是每个区块有一个块头。这个 block header 里面有很多的域，其中有一个域是我们可以设置的随机数 nonce。

## 00:20:00 - 00:22:31 挖矿的过程

挖矿的过程就是不断尝试各种随机数，使得整个区块头哈希之后，落在指定的范围内。小于等于一个目标值。我们要求计算出的哈希值只有落在前面这一点才是合法的。这个目标值是难题友好性的体现。这个挖矿的过程没有捷径，只能通过不断尝试大量的随机数来找到符合要求的解。因此，这个过程可以作为工作量证明。你如果挖到了矿，找到了符合要求的解，那一定是因为你做了大量的工作，因为没有别的捷径。需要注意的是，虽然挖矿的过程需要大量的工作量来找到一个符合要求的随机数，但是一旦有人找到了这样一个随机数并发布出去，其他人要验证这个随机数是否符合要求是非常容易的。只需要计算一次哈希值即可。看它是否小于等于这个目标阈值。挖矿很难，但验证很容易。这个性质是设计这种难题时需要注意的。

## 00:22:49 - 00:23:41 比特币中的哈希函数

比特币中用的哈希函数叫做 SHA256。这个 SHA 的意思是 Secure Hash Algorithm。我们说的这三个性质它都是满足的。这个有的同学可能觉得这个 Puzzle Friendly 跟这个碰撞抵抗性好像有点像。就这两个性质是有一定的联系。但不是完全一样。

## 00:23:41 - 00:24:05 比特币中的密码学功能

我们说比特币中用到了密码学的两个功能，一个是哈希，一个是签名。到这里，我们已经把第一个功能哈希讲完了。我们下面讲签名。要讲签名的话，我们得先讲一下比特币系统中的账户管理。

## 00:24:07 - 00:30:00 比特币中的账户管理

日常生活中，如果你想开个账户，你会怎么办？拿着身份证去银行办理，这就是中心化系统的账户管理方式。比特币是去中心化的，它没有银行之类的机构。那怎么开账户呢？不需要任何人批准，就是创立一个公钥和私钥的对。在本地创立一个公私钥对就是一个账户。这个就在比特币中代表了一个账户。公私钥这个概念呢，是来源于非对称的加密体系，叫做 asymmetric encryption。

最早的加密体系是对称的，最早的叫做对称加密算法。比如说两个人之间要进行通讯。我要把某个信息发给你，但是这个通讯的网络是有可能被窃听的，那怎么办呢？咱们俩事先商量好一个密钥，就一个叫密钥。我把这个信息加密之后发给你，你收到之后再用这个密钥解密，因为这个加密和解密用的是同一个密钥，所以这个叫做对称的加密体系。它这个前提是假设有某种安全的渠道，能够把这个密钥分发给通讯的双方，因为你显然不能够说把这个密钥以明文的形式在网络上传输，我们假设网络本身就是不安全的，有可能被窃听的，这个其实是对称加密体系的一个弱点，就是密钥的分发不是很方便。那解决这个问题呢，非对称加密体系就提出来，我们不是用一个密钥，而是用一对密钥，就有一个公钥和一个私钥，加密用的是公钥。

解密用的是私钥。我要把一个信息传给你，我用你的公钥给这个信息加密。你收到之后，再用你的私钥解密得到原来的信息。大家注意，这个加密和解密用的是同一个人的公钥和私钥，都是这个接收方的公钥和私钥。这个公钥是不用保密的，加密用的公钥是不用保密的。你可以告诉所有的人。有的人他的 home page 上就列出了他的 PGP 公钥。这个私钥是要保密的，因为它是使用私钥解密的。但是私钥只要保存在本地就行了，不用传给对方了。就给你通讯的那个人不需要知道你的私钥。他是用你的公钥加密的。你要回复他的话，你再用他的公钥加密。都不需要知道对方的私钥。这就解决了对称加密体系当中密钥分发不方便的问题。比特币系统中，你要创建一个账户，就在本地产生一个公钥和私钥，一对公钥和私钥。这个公钥就相当于你的银行账号。别人要给你转账，只要知道你的公钥就行了。这个私钥相当于你的账户密码。知道这个私钥，就可以把这个账户上的钱转走。那么有一个问题啊，我们前面说比特币系统是不加密的，他叫加密货币，它其实是不加密的，信息都是公开的。那我要这个公钥和私钥干嘛呢，实际上是用来做签名。

## 00:30:00 - 00:30:51 比特币交易的签名机制

我们讲的第二个功能签名，比如说我要转十个比特币给你，十个比特币有很多钱，我很慷慨转给你。别人怎么知道这个交易确实是我发起的，不是有人偷偷地把我的账上的钱转走了，这就需要我在发布这个交易的时候，要用我自己的私钥对这个交易签名，那其他人收到这个交易之后，再用我的公钥去验证这个签名的正确性。大家听明白了吗，签名用的是私钥验证，签名用的是这个人的公钥，要仍然都是同一个人的。

## 00:31:05 - 00:32:39 公钥生成的唯一性问题

听到这里，大家可能有一个疑问，不需要任何人批准，那么万一两个人生成的公私钥对恰好相同。怎么办，就比如说有人想偷取比特币，一种方法是就不停地产生大量的公私钥，然后对比一下我产生的这个公钥，如果是一样的话。就可以用对应的私钥把这个账上的钱给偷走，这种攻击方法呢从理论上说好像是可以的，但是实际当中是不可行的，就如果你是 256 位的哈希值的话，产生相同的公私钥对的可能性是微乎其微的，就即使你有一台超级计算机，别的事情都不干。每天就不停地产生大量的公私钥对出现两个人的公私钥对相同的概率也是可以忽略不计的，这个概率呢比地球爆炸的概率还要小。就到目前为止，还没有发现哪个人用这种方法，能够攻击成功的先例。

## 00:32:42 - 00:34:01 随机源的重要性

这里要强调一点，我们这里假设产生公私钥的时候，是有一个好的随机源，这叫做 A good source of randomness，生成公私钥的过程显然是随机的，如果不是随机的话，那等于大家都生成同样的公私钥了，如果你选取的这个随机源不好的话，那么前面的分析就不成立了。比如说就有可能出现两个人的公私钥对生成的是一样的，比特币中用的这个签名算法，不光是生成公私钥的时候要有好的随机源，之后每一次签名的时候也要有好的随机源，只要有一次签名的时候，用的随机源不好的话，就有可能泄露私钥，然后就全完了，所以这一点大家一定要特别注意。

## 00:34:02 - 00:34:27 哈希和签名功能的结合应用

我们今天讲解的两个功能，哈希和签名，可以结合使用。在比特币系统中，通常先对一个消息进行哈希运算，然后对这个哈希值进行签名。我们的密码学部分就讲到这里。大家有问题吗？
