# 北京大学肖臻老师《区块链技术与应用》公开课_导读
2024年10月25日 16:36

## 关键词
比特币 网络 交易 区块 传播 节点 种子节点 TCP 鲁棒性 凝聚节点 合法 签名 冲突 区块链 分叉 双花攻击 带宽 支付 商家 投诉 


## 全文摘要
比特币网络采用点对点架构，所有节点平等参与，无超级节点，通过TCP通信确保网络穿透性。该网络采用flooding方式传播消息，依赖随机选取的凝聚节点，虽牺牲效率，却增强了网络的鲁棒性。比特币系统中，每个节点维护待写入区块链的交易集合，接收到合法且未被花过的交易时进行转发。然而，网络中存在race condition问题，即两个冲突交易的广播顺序可能导致不同节点间处理差异。区块传播时，受限于一兆字节的区块大小限制，这导致了传播效率和带宽瓶颈的问题。此外，比特币系统内交易的不可逆性带来了问题，通过新交易作为退款的解决思路，但中心化支付系统同样存在处理线下问题的局限性。


## 章节速览
##### 00:00 比特币网络的工作原理
比特币网络通过其应用层运行比特币协议实现工作，底层基于P2P架构，所有节点平等参与，无需超级或主节点。新交易与区块通过P2P方式在网络中传播，节点间使用TCP通信以确保穿透防火墙。当节点退出网络时，其离开状态将随着时间推移被其他节点识别并删除。

##### 03:23 比特币网络的设计原则与效率牺牲
比特币网络采用简单和鲁棒性原则，不以效率为首要考虑。消息传播通过flooding方式，节点首次收到信息后向所有邻居传播，避免重复转发。凝聚节点随机选取，不考虑物理拓扑，增强网络鲁棒性。节点维护交易等待集合，合法且未使用过的交易才能转发，否则会被视作冲突交易。但这种设计可能引起race condition，即交易冲突导致的双花问题。

##### 08:41 比特币网络区块传播机制及限制
讨论了比特币网络中区块和交易的传播方式，指出大区块传播速度慢，网络限制了区块大小以避免带宽瓶颈。同时，强调了比特币网络的best effort特性，导致交易传播存在延迟和不确定性。

##### 11:20 区块链技术中的交易问题及解决方案
讨论了区块链技术中交易可能出现的问题，包括双花攻击和交易后不发货的情况。指出，尽管区块链理论上可以避免交易篡改，但强大的算力可能会导致分叉链，而实际操作中，如遇不发货问题，现有支付系统及比特币系统都难以自动回滚交易，只能通过其他手段解决，如联系平台客服或选择信誉良好的商家。同时，提出在交易存在问题时，可以通过生成新的交易来实现退款，这在技术上是可行的。


## 思维导图
![思维导图图片](https://tw-efficiency.biz.aliyun.com/api/export/get/v2/2erk9xdaw3jnml8v-1729845512000-3df0d7d6a5ad4b0db7ad2f0f5b04d724.jpg)
## 要点回顾
##### 比特币网络中的交易和区块是如何在系统内传播的？比特币网络中的区块传播规则是怎样的？
在比特币网络中，用户发布的交易被节点接收后打包进区块，并将区块重新发布回网络。新发布的交易和区块在网络上的传播基于一个P2P网络层，该层运行着一种无中心节点、平等连接的网络协议。节点之间通过TCP协议通信以穿透防火墙，并采用 flooding 模式传播消息，即节点首次听到某个消息时会向所有邻居节点转发，后续不再重复转发。每个节点维护一个待写入区块链的交易集合，当节点接收到合法且未被花费过的交易时，将其加入集合并转发给其他邻居节点。新发布的区块在网络上的传播方式类似于交易，每个节点除了检查区块内容的合法性，还需确认它是否位于最长合法链上。区块大小受到一兆字节的限制，这是由于网络采用的传播方式较为耗带宽，一兆区块大小能在保证网络大部分节点接收到区块的同时，控制带宽压力。比特币协议中区块传播也是尽力而为（best effort），存在延迟、顺序不确定等问题，且部分节点可能不遵循协议要求转发消息，导致合法交易无法被网络中所有节点正确接收到。

##### 比特币网络的设计原则是什么？其消息传播机制有何特点？
比特币网络的设计原则强调简单、鲁棒而非高效。其消息传播采取 flooding方式，增强了系统的鲁棒性，但牺牲了部分效率。节点维护一个包含待处理交易的集合，当节点首次听到交易时，若交易未被花费且合法，则将其加入集合并广播给所有邻居节点。为了防止交易在网络中无限传输，节点会在交易被包含在新发布的区块中时，从集合中删除该交易。

##### 在比特币系统中，如何解决支付确认后的纠纷，如商家拒绝发货或商品质量问题？
在比特币系统内部，无法自动回滚已经确认的交易。对于支付纠纷，如商家不发货或商品质量问题，用户需通过电商平台、信誉良好的商家或中心化机构（如支付宝等）进行投诉、协商或寻求法律途径解决。比特币系统本身不支持直接处理此类线下问题，而是依赖于信任机制和中心化服务来解决争议。


## 提取PPT
##### 00:00 比特币网络的工作原理
![PPT图片](https://tw-efficiency.biz.aliyun.com/api/lab/get/v2/3kprql7p5x8y9xgd/23358816.png)
1. 比特币系统中的交易和区块在网络中的传播机制涉及用户首先将交易信息发布到比特币网络上，随后节点接收这些交易，并将它们打包进区块中，最终将新产生的区块及交易信息广播至整个网络。
2. 比特币网络底层构建于点对点(P2P)网络之上，应用层运行着比特币协议，实现交易验证与区块创建；同时，网络层确保了数据包的高效、安全传输，维持着整个网络的正常运行。
3. 在比特币网络中，交易和区块的传播依赖于P2P网络的特性，节点通过向网络中的其他节点广播新产生的区块和交易信息，确保了这些信息能够快速、广泛地传播开来，从而实现全网的共识与同步。
4. 节点之间通过建立连接并交换区块头信息来发现新的区块，并利用这些信息来下载完整的区块数据，这一过程确保了新交易和区块能够被网络中的所有节点所接收和验证，增强了系统的透明度和安全性。
5. 为了防止信息传播过程中的拥堵和延迟，比特币网络采用了基于工作量证明（Proof of Work, PoW）的共识机制，只有那些成功解决特定数学难题的节点（即矿工）才有权创建新的区块，并将交易信息添加进去，这一机制不仅确保了交易的安全性，也控制了网络资源的使用，维持了网络的稳定运行。

![PPT图片](https://tw-efficiency.biz.aliyun.com/api/lab/get/v2/3kprql7p5x8y9xgd/23358817.png)
1. 比特币网络采用纯对等(p2p)架构，所有节点地位平等，没有超级节点或主节点的存在，确保了网络的去中心化特性。
2. 加入比特币网络需至少知晓一个种子节点，通过种子节点获取更多网络节点信息，节点间利用TCP协议通信以增强穿透性。
3. 比特币网络设计强调简单与鲁棒性，而非效率，节点间消息传播采用flooding方式，提升信息传播的广度和速度。
4. 节点间通信不依赖于通知机制，节点退出网络时自动被系统遗忘，通过一定时间间隔后从网络中移除未响应的节点，维持网络健康。

##### 03:23 比特币网络的设计原则与效率牺牲
![PPT图片](https://tw-efficiency.biz.aliyun.com/api/lab/get/v2/3kprql7p5x8y9xgd/23358818.png)
1. 比特币网络中的消息确认机制：节点在接收到某个消息后，会记录下来以防止重复转发，提高网络的鲁棒性，尽管这种方法牺牲了一定的效率，因为它不考虑底层的拓扑结构，可能导致不那么高效的交易处理，比如无论节点离交易发起者多远，处理速度都一样。

2. 交易的合法性检查与处理：比特币网络中，节点在接收交易时，会检查交易的合法性，包括验证交易的签名和确保交易未被重复使用。如果接收到冲突交易，网络会根据节点的接收顺序来决定哪个交易有效，这一过程可能引发race condition问题。

3. 区块链的更新与交易确认：当一个新区块被添加到区块链中时，网络中的节点会根据这个更新来确认哪些交易已经被确认并最终完成。如果一个交易已被包含在新区块中，那么它就从待处理的交易集合中移除，因为该交易现在被视为最终状态。

4. 比特币网络的限制与挑战：比特币协议对区块大小有限制，目的是防止网络带宽被耗尽。尽管一兆字节的限制可能被视为较小，但它反映了比特币网络传播方式的效率问题。此外，比特币网络的传播是尽力而为的，这意味着不是所有节点都能接收到所有的交易，这增加了网络的复杂性和问题，比如双花攻击和合法交易的验证。

5. 比特币网络处理线下问题的局限性：尽管比特币网络在处理交易和区块更新方面有其机制，但它在处理与交易直接相关的问题（如商品未按约定交付）时显得无力。这些问题需要通过外部机制（如联系客服或平台投诉）来解决，显示出比特币网络在解决与交易外部影响相关的问题时的局限性。

##### 08:41 比特币网络区块传播机制及限制
##### 11:20 区块链技术中的交易问题及解决方案
![PPT图片](https://tw-efficiency.biz.aliyun.com/api/lab/get/v2/3kprql7p5x8y9xgd/23358819.png)


