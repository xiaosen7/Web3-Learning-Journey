北京大学肖臻老师《区块链技术与应用》公开课_原文
2024年10月25日 16:36
00:06
我们前面在描述比特币系统的工作过程之中，用户把交易发布到比特币网络上。节点收到这些交易之后，把它们打包到区块里，然后把区块也发布到比特币网络上。那么这些新发布的交易，新发布的区块在比特币网络上是怎么传播的呢？我们现在就讲一下比特币网络的工作原理。

00:57
比特币的工作在应用层，它的底层是一个p two p的over内的工作。就这个应用层application的。

01:17
运行这个比特币协议。

01:31
然后底层。这个网络层network there。

01:47
运行的是一个p two PO类来说。

02:04
比特币的这个p two p网络是非常简单的，所有节点都是对等的。它不像有的p two p网络有所谓的叫超级节点。

02:23
或者有的叫主节点super node，或者叫master node。比特币网络里都没有，所有节点都是平等的。你要加入这个网络，首先你得知道至少有一个种子节点。

02:50
然后你跟那个种子节点联系，他会告诉你他所知道的网络中的其他节点，节点之间是通过TCP来通信的，这样有利于穿透防火墙。然后你离开的时候的话，不需要做任何操作，不用通知其他节点，你就退出你的应用程序就行了。别的节点没有听到你的消息，过了一段时间之后就会把你给删掉。这是一个high lever的工作流程。

03:56
比特币网络的设计原则是简单、鲁棒，而不是高效。

04:30
每个节点维护一个凝聚节点的集合，消息传播在网络中采取就flooding的方式。

04:48
节点第一次听到某个消息的时候，把它传播给其他的所有邻居。节点同时记录一下，这个消息我已经收到了，那么下次再收到这个消息的时候，就不用再转发给邻居这边了。凝聚节点的选取是随机的，没有考虑底层的拓扑结构。比如一个在加利福尼亚的节点，他选的邻居节点可能是在阿根廷的。就这样设计的好处是增强鲁棒性，它没有考虑底下的实际拓扑结构，鲁棒性非常强，但是牺牲的是效率。你向你身边的人转账跟你向美国转账速度其实是差不多的。比特币系统中每个节点要维护一个等待上面的交易的集合。

06:04
比如这个集团当中的交易都是等待要写入区块链里。那么第一次听到某个交易的时候，把这个交易加入了这个集合，并且转发这个交易给邻居节点以后，再收到这个交易的时候，就不用转发了。这样避免这个交易会在网络上无限的传输下去。转发的前提是这个交易者是合法的，他有合法的签名，以前没有被花过。那么这里有一个race condition，就有可能你有两个有冲突的交易，差不多同时被广播到网络上。比如说你有一个交易是A转钱给B。

06:57
另外一个交易，A转钱给C。这两个如果差不多同时广播到网络上的话，那么每个节点根据在网络中的位置的不同，有的可能先收到这个交易，有的可能先收到另外一个交易。比如说有的节点收到A转给B的交易。把它加到集合里。之后再收到A转给C的交易的时候，这个就是非法的。因为跟他有冲突就不管他了。我们假设他们俩花的是同一个币。

07:37
但也有可能有的节点顺序倒过来会先看到这个交易，那这个就不能加入进去。那么这个集合中的交易如果被写到区块链里面，那么就要从这个集合中删掉。比如说这个节点听到一个新发布的区块里面包含了A转给B这个交易，那么这个交易就可以删掉了，因为已经写入到区块链里。如果他听到的新发布的区块是A转给C这个交易。这时候怎么办？这时候其实也要把它删掉。因为这个如果已经被写入到区块里了，那这个就变成非法交易，就变成double stand，这就是race。肯定是可能某个先收到这个交易的节点，抢先挖到矿发过去。

08:47
新发布的区块在网络上的传播方式跟新发布的交易是类似的。每个节点除了要检查这个区块的内容的合法性之还要检查一下它是不是在最长合法链上。越是大的区块，在网络上传播的速度就越慢。

09:11
比特币协议对于这个区块大小有一个限制，有一个。一兆字节的限制。那么有很多人觉得一照太小了。但其实这个限制也是有一定道理的。因为比特币网络采用的这种传播方式是非常耗带宽的，带宽是瓶颈。按照这个一兆的带宽，一兆的区块大小限制来算的话，一个新发布的区块有可能需要几十秒才能传播到网络上的绝大多数界面，这个已经是挺长时间了。最后注意一点，就是我们讲的这个比特币网络，它的传播是属于best effort。

10:27
一个交易发布到这个比特币网络上，不一定所有的节点都能收到。而且不同的节点收到这个交易的顺序也不一定是一样的。网络传播存在延迟，而且这个延迟有的时候可能会很长。而且有的节点不一定按照比特币协议的要求进行转发。比如有的可能该转发的他不转发，导致某些合法的交易收不到。也有的节点可能会转发一些不该转发的消息。比如说有些不合法的交易他也会转发。这就是我们面临的一个实际问题，一个去中心化的系统中面临的实际问题。这个基本上就是我要讲的比特币网络的主要内容。大家有什么问题吗？

11:44
这个就看这个节点是不是有恶意。从道理上说不应该转发非法的交易。但是有很多节点它其实不一定按照规则去转化。就像双花攻击的例子，他想把花过的钱再重新花一遍，这时候他就可能要想各种各样的方法，把第二个这个重复化的交易转发到各个节点城市的节点可能会拒绝。但是如果他算力足够强的话，还是有可能把下面这个分叉的链变成最长方法链。还有别的问题吗？

12:28
发货的话，可能看到有确认之后，就这个东西实际被写到这个区。

12:45
没法回回这边记录已经转过去了。但是人家如果跟他们讨论，就你说的是另外一方面的问题。就我们前面讲的都是说支付的时候会不会作假。我把钱付给商家了，他给我发货了，我再搞一个分叉攻击，让这个交易回滚，把我刷花出的钱又拿回来。你说的是反方面的情况，我支付给商家了，商家不给我货，不给我发货。我支付完之后，我是个普通的老百姓，我又不可能把这个支付交易回滚，或者说回滚的代价可能还不如我这个支付的金额。我可能买的东西可能是几百块钱，我想回滚它的话，我消耗的资源可能是远远超过这个数字。这个是线下的问题，就线上系统都解决不了线下的问。

13:38
我们现在支付系统也有类似的问题。你用银行转账或者你用什么支付宝，你支付完之后那个商家不把东西给你，这个在支付系统内部是没有办法改变的。你没有办法回滚你已经付账的这个交易，你只能联系客服，你去投诉，去找这个平台协商。那都属于这个系统之外，你想别的办法去做这个事情，对吧？因为同样类似的，你可能支付成功了，对方不一定是不给你发货，他给你发的货可能是有问题的。你发现有质量问题，或者是你买的什么什么食品，他腐烂变质了。

14:22
在这种情况下，支付系统内部是没有办法自动回滚这个交易，你只能是说通过其他的方法去解决这个问题。是我一个中医苗信任对吧？那我可以跟针表现像区块的区动，我想去我找便宜都不知道，就是这个事情我要是回我再好。

14:48
是你说的有两点。第一点你是意思是说如果像支付宝这样的，它有个中心化的机构，你投诉的话可以找支付宝去投诉。这个说的对，就比特币这种系统，它支付系统内部是没有办法去受理这些投诉的。那么你怎么去投诉呢？比如说这个电商本身有一定的信誉，如果他对电商老这么干的话，大家不去那买东西。所以找一些比较靠谱的，有信誉的大的商家。另外有的是这个商家是在平台上进行销售的那底下有一个销售平台，就像天猫这种东西，它上面是一个一个商家在上面销售。你可以找这个平台进行投诉，说你上面有什么商家，他销售有什么问题。

15:38
你说的第二个问题其实是不太一样。你说比特币系统，因为它这个区块链你要回滚的话特别麻烦。其实银行转账这种支付方式出现这种投诉，也不是通过回滚的方法准，而是通过产生一个新的交易。就你把钱转给他了，然后你对他不满意，有什么纠纷，他如果承认错误，把钱再转给你那比特币系统也是可以的。你把比特币转给他了，然后他不能发货，他把比特币再转回给你，这个不需要回滚，这是两个独立的交易。就从底层比特币系统来看，这是两个你的交易。从semantic al从我们真正能理解上，我们可以理解成后一个交易是给前一个交易的退款，但这个不需要通过回滚交易来实现。还有别的问题吗？

16:39
没有，好，我们这一节课就到这。
